# SYSTEM SPECIFICATION: FRONTEND (React + Shadcn UI + AudioWorklet)

## 1. PROJECT SETUP & DEPENDENCIES

**Core Stack:**

- React (Vite), TypeScript, Tailwind CSS.
- State Management: `zustand`.
- WebSocket: `react-use-websocket`.
- Icons: `lucide-react`.
- Utils: `clsx`, `tailwind-merge`.

**UI Library: Shadcn UI**

- The Agent MUST follow Shadcn UI patterns.
- Reference: `https://ui.shadcn.com/llms.txt` for component usage.
- Expected components: `Button`, `Card`, `Select`, `ScrollArea`, `Badge`, `Separator`.
- Path alias: `@/components/ui/...` and `@/lib/utils`.

## 2. AUDIO ENGINE (Strict Implementation)

**Constraint:** DO NOT use `MediaRecorder` or `ScriptProcessorNode`. Use **AudioWorklet**.

### A. Processor Logic (`public/pcm-processor.js`)

Create this exact file in `public/`:

```javascript
class PCMProcessor extends AudioWorkletProcessor {
  constructor() {
    super();
    this.bufferSize = 4096;
  }
  process(inputs, outputs, parameters) {
    const input = inputs[0];
    if (!input || !input[0]) return true;
    const inputChannel = input[0];
    // Post raw float32 data to main thread for processing
    this.port.postMessage(inputChannel);
    return true;
  }
}
registerProcessor("pcm-processor", PCMProcessor);
```

### B. Audio Hook (`src/hooks/useAudioRecorder.ts`)

The hook MUST implement:

1.  Initialize `AudioContext` (sampleRate: 16000 preferred, or downsample logic).
2.  Load module: `await ctx.audioWorklet.addModule('/pcm-processor.js')`.
3.  **Downsampling & Conversion Logic (Critical):**
    - If context is 48kHz, decimate (keep 1 out of 3 samples) to get \~16kHz.
    - Convert `Float32` (-1.0 to 1.0) to `Int16` (-32768 to 32767).
4.  Expose `startRecording`, `stopRecording`, and `audioData` (stream).

## 3\. STATE MANAGEMENT (Zustand Store)

File: `src/store/useStore.ts`

```typescript
interface TranscriptSegment {
  id: string;
  text: string;
  isFinal: boolean; // true = confirmed text, false = streaming text
  timestamp: number;
}

interface AppState {
  isConnected: boolean;
  activeModel: "zipformer" | "faster-whisper" | "phowhisper";
  transcripts: TranscriptSegment[];

  // Actions
  setIsConnected: (status: boolean) => void;
  setActiveModel: (model: string) => void;
  handleServerMessage: (data: { text: string; is_final: boolean }) => void;
  // Logic: If is_final=false, replace last segment. If true, append new segment.
}
```

## 4\. WEBSOCKET INTEGRATION

File: `src/hooks/useSocket.ts` (using `react-use-websocket`)

- **Endpoint:** `ws://localhost:8000/ws/transcribe`
- **OnOpen:** Send config JSON: `{ "action": "config", "model": "zipformer" }`
- **SendMessage:** Send **Binary Data** (Int16Array buffer) from the Audio Hook.
- **OnMessage:** Parse JSON -\> Call `useStore.getState().handleServerMessage(data)`.

## 5\. UI LAYOUT

**File: `src/App.tsx`**

- **Header:** Title "Real-time STT Research" + Badge (Online/Offline).
- **Controls:**
  - `Select` component to change Active Model.
  - `Button` (Mic Icon) to toggle recording.
- **Main View:** - `Card` containing `ScrollArea`.
  - Render `transcripts` list.
  - **Styling:** - Final text: `text-foreground` (Black/White).
    - Interim text: `text-muted-foreground` (Gray) + `animate-pulse`.

## 6. API CLIENT GENERATION (Hey-API)

### A. Dependencies

The Agent MUST install the following libraries:

- `@hey-api/openapi-ts`: For generating the client.
- `@hey-api/client-fetch`: The runtime client.

### B. Configuration (`openapi-ts.config.ts`)

Create this configuration file in the root:

```typescript
import { defineConfig } from "@hey-api/openapi-ts";

export default defineConfig({
  client: "@hey-api/client-fetch",
  input: "http://localhost:8000/openapi.json", // Read directly from running BE
  output: "src/client", // Generate code into this folder
});
```

### C. Scripts (`package.json`)

Add a script to generate the API client:
`"gen:api": "openapi-ts"`

### D. Usage Strategy (Hybrid Approach)

1.  **For REST API (Models, History, Config):**
    - MUST import functions from `@/client`.
    - Example: `import { getApiV1Models } from '@/client'`
    - Configure the base client once in `src/main.tsx`:
      ```typescript
      import { client } from "@/client";
      client.setConfig({ baseUrl: "http://localhost:8000" });
      ```
2.  **For WebSocket (Streaming):**
    - Continue using `react-use-websocket` (generated clients typically handle HTTP best, not streaming WS).

## 7\. UPDATED FOLDER STRUCTURE (Frontend)

```
frontend/
  ├── openapi-ts.config.ts  # [NEW] Config for generator
  ├── src/
  │   ├── client/           # [NEW] Auto-generated by hey-api (Do not edit manually)
  │   │   ├── index.ts
  │   │   ├── services.gen.ts
  │   │   └── types.gen.ts
  │   ├── ...

```
